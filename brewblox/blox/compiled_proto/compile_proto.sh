#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(dirname "$0")"
PROTO_DIR="$(readlink -f "${SCRIPT_DIR}/../proto")"
NANOPB_PATH="$(readlink -f "${PROTO_DIR}/../../../platform/spark/device-os/third_party/nanopb/nanopb")"
PROTOC_NANOPB_PLUGIN="${NANOPB_PATH}/generator/protoc-gen-nanopb"

pushd "$PROTO_DIR" >/dev/null # .option files are read from execution directory, so have to cd into this dir

# To prevent recompiling of files when making changes to protos often, use line below to only recompile changed files
# PROTO_FILES="$(git diff --name-only | sed "s,^,${PROTO_DIR}/," | tr '\n' ' ')"
PROTO_FILES="${PROTO_DIR}/*.proto"

protoc -I"${PROTO_DIR}" -I"${NANOPB_PATH}/generator" \
    --nanopb_out=../compiled_proto/src \
    --proto_path="${PROTO_DIR}" \
    --plugin=protoc-gen-nanopb="${PROTOC_NANOPB_PLUGIN}" \
    ${PROTO_FILES} # don't quote

rm -f ../compiled_proto/src/nanopb.* # nanopb.h and nanopb.c are not needed and generate compiler warnings when they are not removed

for file in ../compiled_proto/src/*; do
    # remove timestamp from file (or it will always be modified)
    sed -i '/Generated by nanopb-/d' "${file}"
done

COMPILED_PROTO_VERSION=$(
    cd "$PROTO_DIR"
    git rev-parse --short=8 HEAD
)
COMPILED_PROTO_DATE=$(
    cd "$PROTO_DIR"
    git log -1 --format=%cd --date=short
)

rm -rf ../compiled_proto/src/proto_version.h
{
    echo "#pragma once"
    echo "#define COMPILED_PROTO_VERSION \"${COMPILED_PROTO_VERSION}\""
    echo "#define COMPILED_PROTO_DATE \"${COMPILED_PROTO_DATE}\""
} >>../compiled_proto/src/proto_version.h
