## -*- Makefile -*-

CCC = gcc
CXX = g++
LD = g++
CFLAGS = -g
CCFLAGS = $(CFLAGS)
CXXFLAGS = $(CFLAGS)
RM = rm -f
RMDIR = rm -f -r
MKDIR = mkdir -p

TARGETDIR=build
TARGET=brewblox_test_runner

mkfile_path := $(abspath $(lastword $(MAKEFILE_LIST)))
mkfile_dir := $(dir $(mkfile_path))
remove_slash = $(patsubst %/,%,$1)
SOURCE_PATH = $(abspath mkfile_dir/../../../..)

BUILD_PATH=$(TARGETDIR)/test
# Define the target directories. Nest 2 levels deep since we also include
# sources from libraries via ../core-common-lib

# Recursive wildcard function
rwildcard = $(wildcard $1$2) $(foreach d,$(wildcard $1*),$(call rwildcard,$d/,$2))

# enumerates files in the filesystem and returns their path relative to the project root
# $1 the directory relative to the project root
# $2 the pattern to match, e.g. *.cpp
target_files = $(patsubst $(SOURCE_PATH)/%,%,$(call rwildcard,$(SOURCE_PATH)/$1,$2))

# here_files is a non-recursive file search. target_files is recursive.
here_files = $(patsubst $(SOURCE_PATH)/%,%,$(wildcard $(SOURCE_PATH)/$1/$2))

# add all tests
CPPSRC += $(call here_files,app/brewblox-particle/test,*.cpp)

# add all objects the user can create
INCLUDE_DIRS += $(SOURCE_PATH)/app/brewblox-particle/
INCLUDE_DIRS += $(SOURCE_PATH)/brewblox/
CPPSRC += $(call here_files,app/brewblox-particle/blox,*.cpp)
CPPSRC += $(call here_files,brewblox/blox,*.cpp)

# add all lib source files
INCLUDE_DIRS += $(SOURCE_PATH)/lib/inc
CPPSRC += $(call here_files,lib/src,*.cpp)

# add all controlbox source files
INCLUDE_DIRS += $(SOURCE_PATH)/controlbox/src/
CPPSRC += $(call here_files,controlbox/src/cbox,*.cpp)

# add shared brewblox sources for all platforms
INCLUDE_DIRS += $(SOURCE_PATH)/brewblox
CPPSRC += $(call here_files,brewblox,*.cpp)

# exclude touch and wifi from test build
CPPEXCLUDES += app/brewblox-particle/blox/TouchSettingsBlock.cpp
CPPEXCLUDES += app/brewblox-particle/blox/WiFiSettingsBlock.cpp

# include stubs for hal
CPPSRC += $(call here_files,platform/stub,*.cpp)

# add protobuf includes generated by nanopb
CFLAGS += -isystem $(SOURCE_PATH)/brewblox/blox/proto/cpp
CSRC += $(call here_files,brewblox/blox/proto/cpp,*.c)

# add protobuf includes generated by google protobuf 
CFLAGS += -isystem $(SOURCE_PATH)/brewblox/blox/proto/test/cpp
CPPSRC += $(call here_files,brewblox/blox/proto/test/cpp,*.cpp)

# add board files (tests use emulated hardware)
INCLUDE_DIRS += $(SOURCE_PATH)/platform/spark/modules/Board
CPPSRC += $(call here_files,platform/spark/modules/Board,*.cpp)

# add nanopb dependencies
INCLUDE_DIRS += $(SOURCE_PATH)/platform/spark/device-os/third_party/nanopb/nanopb
CSRC += $(call here_files,platform/spark/device-os/third_party/nanopb/nanopb,*.c)
# enable message id's
CFLAGS += -DPB_MSGID=1

INCLUDE_DIRS += $(SOURCE_PATH)/platform

# brewblox app specific implementations
CPPSRC += app/brewblox-particle/brewblox_particle.cpp
CPPSRC += app/brewblox-particle/AppTicks.cpp

# catch test
INCLUDE_DIRS += $(SOURCE_PATH)/platform/spark/device-os/third_party/catch2/catch2/single_include/catch2

# spark HAL includes
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/hal/inc
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/hal/shared
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/services/inc
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/hal/src/gcc
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/hal/src/newhal
CPPFLAGS += -isystem $(SOURCE_PATH)/platform/spark/device-os/wiring/inc

CPPSRC += /platform/spark/device-os/hal/src/gcc/gpio_hal.cpp
CPPSRC += /platform/spark/device-os/hal/src/gcc/eeprom_hal.cpp
CPPSRC += /platform/spark/device-os/hal/src/gcc/filesystem.cpp
CPPSRC += /platform/spark/device-os/test/unit_tests/communication/hal_stubs.cpp

CPPSRC += controlbox/test/TestHelpers.cpp

CFLAGS += -DPLATFORM_ID=3

# include boost
ifeq ($(BOOST_ROOT),)
$(error BOOST_ROOT not set. Download boost and add BOOST_ROOT to your environment variables.)
endif
CPPFLAGS += -isystem $(BOOST_ROOT)

CFLAGS += $(patsubst %,-I%,$(INCLUDE_DIRS)) -I.
CFLAGS += -ffunction-sections -Wall
CFLAGS += -Wno-deprecated
CFLAGS += -Wnull-dereference 
CPPFLAGS += -fdiagnostics-show-template-tree -fno-elide-type # GCC8 required
CFLAGS += -Wextra
CFLAGS += -Wpedantic -Wvla -Wswitch-enum -fvar-tracking-assignments 
CFLAGS += -Wduplicated-cond -Wduplicated-branches -rdynamic
CPPFLAGS += -Wextra-semi

# Flag compiler error for [-Wdeprecated-declarations]
CFLAGS += -Werror=deprecated-declarations

# Generate dependency files automatically.
CFLAGS += -MD -MP -MF $@.d
CFLAGS += -DDEBUG_BUILD
# OSX includes sys/wait.h which defines "wait"
CFLAGS += -D_SYS_WAIT_H_ -D_SYS_WAIT_H

CPPFLAGS += -std=gnu++14
CFLAGS += -pthread


# compile with coverage
CFLAGS += -g -fprofile-arcs -ftest-coverage
LDFLAGS += -lgcov

# compile with coverage and sanitizer (uncommented because cnl doesn't work well with it)
# include $(SOURCE_PATH)/build/checkers.mk # sanitizer and gcov

# the following warnings can help find opportunities for impromevent in virtual functions
# Warn when virtual functions are overriden without override/override final specifier (requires gcc 5.1)
# CPPFLAGS += -Wsuggest-override
# Warn when functions and classes can be marked final
# CPPFLAGS += -Wsuggest-final-types
# CPPFLAGS += -Wsuggest-final-methods

# set cnl as system includes to suppress warnings
CPPFLAGS += -isystem $(SOURCE_PATH)/lib/cnl/include

# include google protobuf dependencies
CPPFLAGS += $(shell pkg-config --cflags protobuf)
LDFLAGS += $(shell pkg-config --libs protobuf)

# don't generate warnings for system headers
CFLAGS += -Wno-system-headers

GIT_VERSION = $(shell cd $(SOURCE_PATH); git rev-parse --short=8 HEAD)
$(info using $(GIT_VERSION) as version)
CFLAGS += -DGIT_VERSION="$(GIT_VERSION)"

GIT_DATE = $(shell cd $(SOURCE_PATH); git log -1 --format=%cd --date=short)
$(info using $(GIT_DATE) as release date)
CFLAGS += -DGIT_DATE="$(GIT_DATE)"

PROTO_VERSION = $(shell cd $(SOURCE_PATH)/brewblox/blox/proto; git rev-parse --short=8 HEAD)
$(info using $(PROTO_VERSION) as protocol version)
CFLAGS += -DPROTO_VERSION="$(PROTO_VERSION)"

PROTO_DATE = $(shell cd $(SOURCE_PATH)/brewblox/blox/proto; git log -1 --format=%cd --date=short)
$(info using $(GIT_DATE) as protocol date)
CFLAGS += -DPROTO_DATE="$(PROTO_DATE)"

CSRC := $(filter-out $(CEXCLUDES),$(CSRC))
CPPSRC := $(filter-out $(CPPEXCLUDES),$(CPPSRC)) 

# Collect all object and dep files
ALLOBJ += $(addprefix $(BUILD_PATH)/, $(CSRC:.c=.o))
ALLOBJ += $(addprefix $(BUILD_PATH)/, $(CPPSRC:.cpp=.o))

ALLDEPS += $(addprefix $(BUILD_PATH)/, $(CSRC:.c=.o.d))
ALLDEPS += $(addprefix $(BUILD_PATH)/, $(CPPSRC:.cpp=.o.d))

all: runner

runner: $(TARGETDIR)/$(TARGET)

$(TARGETDIR)/$(TARGET) : $(BUILD_PATH) $(ALLOBJ)
	@echo Building target: $@
	@$(MKDIR) $(dir $@)
	@$(LD) $(CFLAGS) $(ALLOBJ) --output $@ $(LDFLAGS)
	@echo

$(BUILD_PATH): 
	$(MKDIR) $(BUILD_PATH)

# Tool invocations

# C compiler to build .o from .c in $(BUILD_DIR)
$(BUILD_PATH)%.o : $(SOURCE_PATH)%.c
	@echo Building file: $<
	@$(MKDIR) $(dir $@)
	@$(CCC) $(CCFLAGS) -s -c -o $@ $<

# CPP compiler to build .o from .cpp in $(BUILD_DIR)
# Note: Calls standard $(CC) - gcc will invoke g++ as appropriate
$(BUILD_PATH)%.o : $(SOURCE_PATH)%.cpp
	@echo Building file: $<
	@$(MKDIR) $(dir $@)
	@$(CXX) $(CXXFLAGS) $(CPPFLAGS) -s -c -o $@ $<

# Other Targets
clean:	
	$(RM) $(ALLOBJ) $(ALLDEPS) $(TARGETDIR)/$(TARGET)
	$(RMDIR) $(TARGETDIR)
	#$(RMDIR) $(SOURCE_PATH)/brewblox/blox/proto/cpp
	#$(RMDIR) $(SOURCE_PATH)/brewblox/blox/proto/test
	@echo

# print variable by invoking make print-VARIABLE as VARIABLE = the_value_of_the_variable
print-%  : ; @echo $* = $($*)

.PHONY: all clean runner
.SECONDARY:

# Include auto generated dependency files
-include $(ALLDEPS)



