## -*- Makefile -*-

CCFLAGS = $(CFLAGS)
CXXFLAGS = $(CFLAGS)

ROOT_DIR = $(shell git rev-parse --show-toplevel)

# include ../checkers.mk # sanitizer and gcov

# lib/blocks
INCLUDE_DIRS += $(ROOT_DIR)/lib/blocks/inc
CPPSRC += $(wildcard $(ROOT_DIR)/lib/blocks/src/*.cpp)

# lib/cbox
INCLUDE_DIRS += $(ROOT_DIR)/lib/cbox/inc
CPPSRC += $(wildcard $(ROOT_DIR)/lib/cbox/src/*.cpp)

# lib/control
INCLUDE_DIRS += $(ROOT_DIR)/lib/control/inc
# CPPSRC += $(call here_files,lib/control/src,*.cpp)
CPPSRC += $(wildcard $(ROOT_DIR)/lib/control/src/*.cpp)

# lib/hal - only build stubs
INCLUDE_DIRS += $(ROOT_DIR)/lib/blox_hal/inc
CPPSRC += $(wildcard $(ROOT_DIR)/platform/stub/*.cpp)

# lib/proto
INCLUDE_DIRS += $(ROOT_DIR)/lib/proto/inc
CSRC += $(wildcard $(ROOT_DIR)/lib/proto/inc/proto/*.pb.c)

# test/proto
# protobuf sources generated by google protobuf for tests
INCLUDE_DIRS += $(ROOT_DIR)/test/proto/inc
CCSRC += $(wildcard $(ROOT_DIR)/test/proto/inc/proto/*.pb.cc)

# platform
INCLUDE_DIRS += $(ROOT_DIR)/platform/particle/spark/inc
INCLUDE_DIRS += $(ROOT_DIR)/platform/particle/d4d_display/inc
INCLUDE_DIRS += $(ROOT_DIR)/platform/particle/mdns/inc
INCLUDE_DIRS += $(ROOT_DIR)/platform/particle/eGUI/D4D

# add board files (tests use emulated hardware)
INCLUDE_DIRS += $(ROOT_DIR)/platform/particle/spark/inc
CPPSRC += platform/particle/spark/src/Board.cpp

# device-os nanopb
INCLUDE_DIRS += $(ROOT_DIR)/external_libs/device-os/third_party/nanopb/nanopb
CSRC += $(wildcard $(ROOT_DIR)/external_libs/device-os/third_party/nanopb/nanopb/*.c)

# test/shared
INCLUDE_DIRS += $(ROOT_DIR)/test/shared
CPPSRC += $(wildcard $(ROOT_DIR)/test/shared/*.cpp)

# tests
CPPSRC += test/blocks/runner.cpp
CPPSRC += test/blocks/TestCboxApplication.cpp
CPPSRC += test/blocks/ActuatorLogicBlock_test.cpp
CPPSRC += test/blocks/ActuatorOffsetBlock_test.cpp
CPPSRC += test/blocks/ActuatorPwmBlock_test.cpp
CPPSRC += test/blocks/AutoDiscover_test.cpp
CPPSRC += test/blocks/BalancerAndMutexBlock_test.cpp
CPPSRC += test/blocks/DigitalActuatorBlock_test.cpp
# CPPSRC += $(wildcard $(ROOT_DIR)/test/blocks/*.cpp)

# app/brewblox-particle
INCLUDE_DIRS += $(ROOT_DIR)/app/brewblox-particle/inc

# Only include source files without external dependencies
CPPSRC += app/brewblox-particle/src/brewblox_particle.cpp
CPPSRC += app/brewblox-particle/src/AppTicks.cpp
CPPSRC += app/brewblox-particle/src/Spark2PinsBlock.cpp
CPPSRC += app/brewblox-particle/src/Spark3PinsBlock.cpp
CPPSRC += app/brewblox-particle/src/SparkIoBase.cpp

# catch test
INCLUDE_DIRS += $(ROOT_DIR)/external_libs/device-os/third_party/catch2/catch2/single_include/catch2

# spark HAL includes
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/hal/inc
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/hal/shared
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/services/inc
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/hal/src/gcc
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/hal/src/newhal
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/device-os/wiring/inc
CPPFLAGS += -isystem $(ROOT_DIR)/external_libs/cnl/include

CPPSRC += external_libs/device-os/hal/src/gcc/gpio_hal.cpp
CPPSRC += external_libs/device-os/hal/src/gcc/eeprom_hal.cpp
CPPSRC += external_libs/device-os/hal/src/gcc/filesystem.cpp
CPPSRC += external_libs/device-os/test/unit_tests/communication/hal_stubs.cpp

CFLAGS += -DPLATFORM_ID=3

# include boost
CPPFLAGS += -isystem $(BOOST_ROOT)

# include google protobuf dependencies
CPPFLAGS += $(shell pkg-config --cflags protobuf)
LDFLAGS += $(shell pkg-config --libs protobuf)
CFLAGS += -DPB_MSGID=1

# Generate dependency files automatically.
CFLAGS += -MD -MP -MF $@.d
CFLAGS += -DDEBUG_BUILD

CFLAGS += -ffunction-sections -Wall
CFLAGS += -Werror=deprecated-declarations

CPPFLAGS += -std=gnu++17
CFLAGS += -pthread

CPPFLAGS += -Wsuggest-override
CPPFLAGS += -Wsuggest-final-types
CPPFLAGS += -Wsuggest-final-methods

# don't generate warnings for system headers
CFLAGS += -Wno-system-headers

include ../targets.mk
